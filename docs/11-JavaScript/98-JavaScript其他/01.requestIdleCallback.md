---
title: requestIdleCallback
---

## requestIdleCallback æ˜¯ä»€ä¹ˆï¼Ÿ

requestIdleCallback æ˜¯ä¸€ä¸ªè¿˜åœ¨å®éªŒä¸­çš„ api,å¯ä»¥è®©æˆ‘ä»¬åœ¨æµè§ˆå™¨ç©ºé—²çš„æ—¶å€™åšä¸€äº›äº‹æƒ…

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/038ea55906694169b3fed2760ba60e7c~tplv-k3u1fbpfcp-watermark.awebp)

RequestIdleCallback ç®€å•çš„è¯´ï¼Œåˆ¤æ–­ä¸€å¸§æœ‰ç©ºé—²æ—¶é—´ï¼Œåˆ™å»æ‰§è¡ŒæŸä¸ªä»»åŠ¡ã€‚
ç›®çš„æ˜¯ä¸ºäº†è§£å†³å½“ä»»åŠ¡éœ€è¦é•¿æ—¶é—´å ç”¨ä¸»è¿›ç¨‹ï¼Œå¯¼è‡´æ›´é«˜ä¼˜å…ˆçº§ä»»åŠ¡(å¦‚åŠ¨ç”»æˆ–äº‹ä»¶ä»»åŠ¡)ï¼Œæ— æ³•åŠæ—¶å“åº”ï¼Œè€Œå¸¦æ¥çš„é¡µé¢ä¸¢å¸§(å¡æ­»)æƒ…å†µã€‚
æ•…RequestIdleCallback å®šä½å¤„ç†çš„æ˜¯: **ä¸é‡è¦ä¸”ä¸ç´§æ€¥çš„ä»»åŠ¡**ã€‚

### åŸºæœ¬è¯­æ³•

```js
var handle = window.requestIdleCallback(callback[, options])
```

- è¿”å›å€¼
ä¸€ä¸ªIDï¼Œå¯ä»¥æŠŠå®ƒä¼ å…¥ Window.cancelIdleCallback() æ–¹æ³•æ¥ç»“æŸå›è°ƒã€‚

- callback
ä¸€ä¸ªåœ¨äº‹ä»¶å¾ªç¯ç©ºé—²æ—¶å³å°†è¢«è°ƒç”¨çš„å‡½æ•°çš„å¼•ç”¨ã€‚å‡½æ•°ä¼šæ¥æ”¶åˆ°ä¸€ä¸ªåä¸º IdleDeadline çš„å‚æ•°ï¼Œè¿™ä¸ªå‚æ•°å¯ä»¥è·å–å½“å‰ç©ºé—²æ—¶é—´ä»¥åŠå›è°ƒæ˜¯å¦åœ¨è¶…æ—¶æ—¶é—´å‰å·²ç»æ‰§è¡Œçš„çŠ¶æ€ã€‚

- options å¯é€‰
åŒ…æ‹¬å¯é€‰çš„é…ç½®å‚æ•°ã€‚å…·æœ‰å¦‚ä¸‹å±æ€§ï¼š
timeoutï¼š å¦‚æœæŒ‡å®šäº†timeoutï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ªæ­£å€¼ï¼Œè€Œå›è°ƒåœ¨timeoutæ¯«ç§’è¿‡åè¿˜æ²¡æœ‰è¢«è°ƒç”¨ï¼Œé‚£ä¹ˆå›è°ƒä»»åŠ¡å°†æ”¾å…¥äº‹ä»¶å¾ªç¯ä¸­æ’é˜Ÿï¼Œå³ä½¿è¿™æ ·åšæœ‰å¯èƒ½å¯¹æ€§èƒ½äº§ç”Ÿè´Ÿé¢å½±å“ã€‚

### åŸºæœ¬åº”ç”¨

```ts
type Deadline = {
  timeRemaining: () => number // å½“å‰å‰©ä½™çš„å¯ç”¨æ—¶é—´ã€‚å³è¯¥å¸§å‰©ä½™æ—¶é—´ã€‚
  didTimeout: boolean // æ˜¯å¦è¶…æ—¶ã€‚
}

function work(deadline:Deadline) { // deadline ä¸Šé¢æœ‰ä¸€ä¸ª timeRemaining() æ–¹æ³•ï¼Œèƒ½å¤Ÿè·å–å½“å‰æµè§ˆå™¨çš„å‰©ä½™ç©ºé—²æ—¶é—´ï¼Œ
å•ä½ msï¼›æœ‰ä¸€ä¸ªå±æ€§ didTimeoutï¼Œè¡¨ç¤ºæ˜¯å¦è¶…æ—¶
  console.log(`å½“å‰å¸§å‰©ä½™æ—¶é—´: ${deadline.timeRemaining()}`);
  if (deadline.timeRemaining() > 1 || deadline.didTimeout) {
     // èµ°åˆ°è¿™é‡Œï¼Œè¯´æ˜æ—¶é—´æœ‰ä½™ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨è¿™é‡Œå†™è‡ªå·±çš„ä»£ç é€»è¾‘
  }
  // èµ°åˆ°è¿™é‡Œï¼Œè¯´æ˜æ—¶é—´ä¸å¤Ÿäº†ï¼Œå°±è®©å‡ºæ§åˆ¶æƒç»™ä¸»çº¿ç¨‹ï¼Œä¸‹æ¬¡ç©ºé—²æ—¶ç»§ç»­è°ƒç”¨
  requestIdleCallback(work);
}
requestIdleCallback(work, { timeout: 1000 }); // è¿™è¾¹å¯ä»¥ä¼ ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼ˆå¿…ä¼ ï¼‰å’Œå‚æ•°ï¼ˆç›®å‰å°±åªæœ‰è¶…æ—¶è¿™ä¸€ä¸ªå‚æ•°ï¼‰
```

### ç¼ºç‚¹

- è¿™æ˜¯ä¸€ä¸ªå®éªŒä¸­çš„åŠŸèƒ½
æ­¤åŠŸèƒ½æŸäº›æµè§ˆå™¨å°šåœ¨å¼€å‘ä¸­ï¼Œè¯·å‚è€ƒæµè§ˆå™¨å…¼å®¹æ€§è¡¨æ ¼ä»¥å¾—åˆ°åœ¨ä¸åŒæµè§ˆå™¨ä¸­é€‚åˆä½¿ç”¨çš„å‰ç¼€ã€‚ç”±äºè¯¥åŠŸèƒ½å¯¹åº”çš„æ ‡å‡†æ–‡æ¡£å¯èƒ½è¢«é‡æ–°ä¿®è®¢ï¼Œæ‰€ä»¥åœ¨æœªæ¥ç‰ˆæœ¬çš„æµè§ˆå™¨ä¸­è¯¥åŠŸèƒ½çš„è¯­æ³•å’Œè¡Œä¸ºå¯èƒ½éšä¹‹æ”¹å˜ã€‚

- [å®éªŒè¿‡ç¨‹](https://github.com/Linjiayu6/FE-RequestIdleCallback-demo)
å®éªŒç»“è®º: requestIdleCallback FPSåªæœ‰20msï¼Œæ­£å¸¸æƒ…å†µä¸‹æ¸²æŸ“ä¸€å¸§æ—¶é•¿æ§åˆ¶åœ¨16.67ms (1s / 60 = 16.67ms)ã€‚è¯¥æ—¶é—´æ˜¯é«˜äºé¡µé¢æµç•…çš„è¯‰æ±‚ã€‚

- æœ‰äººè®¤ä¸º
RequestIdleCallback ä¸é‡è¦ä¸”ä¸ç´§æ€¥çš„å®šä½ã€‚å› ä¸ºReactæ¸²æŸ“å†…å®¹ï¼Œå¹¶éæ˜¯ä¸é‡è¦ä¸”ä¸ç´§æ€¥ã€‚ä¸ä»…è¯¥apiå…¼å®¹ä¸€èˆ¬ï¼Œå¸§æ¸²æŸ“èƒ½åŠ›ä¸€èˆ¬ï¼Œä¹Ÿä¸å¤ªç¬¦åˆæ¸²æŸ“è¯‰æ±‚ï¼Œæ•…React å›¢é˜Ÿè‡ªè¡Œå®ç°

## requestIdleCallback å’Œ requestAnimationFrame çš„åŒºåˆ«

requestAnimationFrame çš„å›è°ƒä¼šåœ¨æ¯ä¸€å¸§ç¡®è®¤æ‰§è¡Œ, å±äºé«˜ä¼˜å…ˆçº§ä»»åŠ¡. è€Œ requestIdleCallback çš„å›è°ƒä¸ä¸€å®š, å±äºä½ä¼˜å…ˆçº§ä»»åŠ¡.
æˆ‘ä»¬çœ‹åˆ°çš„é¡µé¢æ˜¯æµè§ˆå™¨ä¸€å¸§ä¸€å¸§ç»˜åˆ¶å‡ºæ¥çš„, é€šå¸¸ FPS åœ¨ 60 çš„æ—¶å€™æ˜¯æ¯”è¾ƒæµç•…çš„, è€Œ FPS æ¯”è¾ƒä½çš„æ—¶å€™å°±ä¼šæ„Ÿè§‰åˆ°å¡é¡¿.
é‚£ä¹ˆåœ¨æ¯ä¸€å¸§é‡Œæµè§ˆå™¨ä¼šåšå“ªäº›äº‹æƒ…å‘¢, å¦‚ä¸‹å›¾æ‰€ç¤º:

![](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c7885e81d59849868445d3c0b37d655d~tplv-k3u1fbpfcp-watermark.awebp?)

å›¾ä¸­ä¸€å¸§åŒ…æ‹¬äº†ç”¨æˆ·çš„äº¤äº’, JavaScript è„šæœ¬æ‰§è¡Œ; ä»¥åŠ ***requestAnimationFrame(rAF)***çš„è°ƒç”¨, å¸ƒå±€è®¡ç®—ä»¥åŠé¡µé¢é‡ç»˜ç­‰.
å‡å¦‚æŸä¸€å¸§é‡Œæ‰§è¡Œçš„ä»»åŠ¡ä¸å¤š, åœ¨ä¸åˆ° 16.66ms(1000/60)å†…å°±å®Œæˆäº†ä¸Šè¿°ä»»åŠ¡, é‚£ä¹ˆè¿™ä¸€å¸§å°±ä¼šæœ‰ä¸€å®šç©ºé—²æ—¶é—´æ¥æ‰§è¡Œ ***requestIdleCallback*** çš„å›è°ƒ, å¦‚å›¾æ‰€ç¤º:

![](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6c897de9b44c45faa24fced21b38c3a6~tplv-k3u1fbpfcp-watermark.awebp?)

å½“ç¨‹åºæ ˆä¸ºç©ºé¡µé¢æ— éœ€æ›´æ–°çš„æ—¶å€™, æµè§ˆå™¨å…¶å®æ˜¯å¤„äºç©ºé—²çŠ¶æ€, è¿™æ—¶å€™ç•™ç»™requestIdleCallbackæ‰§è¡Œçš„æ—¶é—´å°±å¯ä»¥é€‚å½“æ‹‰é•¿, æœ€é•¿è¾¾åˆ° 50ms, ä»¥é˜²å‡ºç°ä¸å¯é¢„æµ‹çš„ä»»åŠ¡(å¦‚ç”¨æˆ·è¾“å…¥), é¿å…æ— æ³•åŠæ—¶å“åº”ä½¿ç”¨æˆ·æ„ŸçŸ¥åˆ°å»¶è¿Ÿ.
![](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/171dab554daa414390ee6a72f2fd6446~tplv-k3u1fbpfcp-watermark.awebp?)

ç”±äºrequestIdleCallbackåˆ©ç”¨çš„æ˜¯å¸§çš„ç©ºé—²æ—¶é—´, æ‰€ä»¥æœ‰å¯èƒ½å‡ºç°æµè§ˆå™¨ä¸€ç›´å¤„äºç¹å¿™çŠ¶æ€, å¯¼è‡´å›è°ƒä¸€ç›´æ— æ³•æ‰§è¡Œ, é‚£è¿™æ—¶å€™å°±éœ€è¦åœ¨è°ƒç”¨requestIdleCallbackçš„æ—¶å€™ä¼ é€’ç¬¬äºŒä¸ªé…ç½®å‚æ•°timeoutäº†.

```js
requestIdleCallback(myNonEssentialWork, { timeout: 2000 });

function myNonEssentialWork(deadline) {
  // å½“å›è°ƒå‡½æ•°æ˜¯ç”±äºè¶…æ—¶æ‰å¾—ä»¥æ‰§è¡Œçš„è¯ï¼Œdeadline.didTimeoutä¸ºtrue
  while (
    (deadline.timeRemaining() > 0 || deadline.didTimeout) &&
    tasks.length > 0
  ) {
    doWorkIfNeeded();
  }
  if (tasks.length > 0) {
    requestIdleCallback(myNonEssentialWork);
  }
}
```

å¦‚æœæ˜¯å› ä¸ºtimeoutå›è°ƒæ‰å¾—ä»¥æ‰§è¡Œçš„è¯, ç”¨æˆ·å°±æœ‰å¯èƒ½æ„Ÿå—åˆ°å¡é¡¿, å› ä¸ºä¸€å¸§çš„æ—¶é—´å·²ç»è¶…è¿‡ 16ms äº†.

## requestIdleCallback åœ¨ç©ºé—²æ—¶é—´é‡Œæœ‰å“ªäº›èƒ½åšå’Œä¸èƒ½åš

### ä¸è¦åšä»€ä¹ˆ

1. ä¸è¦åœ¨requestIdleCallback é‡Œæ‰§è¡Œä¿®æ”¹DOMæ“ä½œ

å¼ºçƒˆå»ºè®®ä¸è¦åœ¨requestIdleCallbacké‡Œé¢æ‰§è¡Œä¿®æ”¹ DOM çš„æ“ä½œ.
ä»ä¸Šé¢ä¸€å¸§çš„æ„æˆä¸­å¯ä»¥çœ‹åˆ°, requestIdleCallbackå›è°ƒæ‰§è¡Œä¹‹å‰, æ ·å¼å˜æ›´ä»¥åŠå¸ƒå±€è®¡ç®—ç­‰éƒ½å·²ç»å®Œæˆ. å¦‚æœåœ¨callbackä¸­ä¿®æ”¹ DOM çš„è¯, ä¹‹å‰æ‰€ä½œçš„å¸ƒå±€è®¡ç®—éƒ½ä¼šå¤±æ•ˆ. å¹¶ä¸”å¦‚æœä¸‹ä¸€å¸§é‡Œæœ‰è·å–å¸ƒå±€ç›¸å…³çš„æ“ä½œ, æµè§ˆå™¨å°±éœ€è¦å¼ºåˆ¶è¿›è¡Œé‡æ’, æå¤§çš„å½±å“æ€§èƒ½. å¦å¤–ç”±äºä¿®æ”¹ DOM çš„æ—¶é—´æ˜¯ä¸å¯é¢„æµ‹çš„, å› æ­¤å®¹æ˜“è¶…è¿‡å½“å‰å¸§ç©ºé—²çš„é˜ˆå€¼.

æ¨èçš„åšæ³•æ˜¯åœ¨ ***requestAnimationFrame***é‡Œé¢åš DOM çš„ä¿®æ”¹.

2. é™¤äº†ä¸æ¨è DOM ä¿®æ”¹æ“ä½œå¤–, **Promiseçš„resolve(reject)**æ“ä½œä¹Ÿä¸å»ºè®®æ”¾åœ¨é‡Œé¢, å› ä¸ºPromiseçš„å›è°ƒä¼šåœ¨ idle çš„å›è°ƒæ‰§è¡Œå®Œæˆåç«‹å³æ‰§è¡Œ, æ‹‰é•¿å½“å‰å¸§çš„è€—æ—¶. promise çš„å›è°ƒå±äºä¼˜å…ˆçº§è¾ƒé«˜çš„å¾®ä»»åŠ¡ï¼Œæ‰€ä»¥ä¼šåœ¨ requestIdleCallback å›è°ƒç»“æŸåç«‹å³æ‰§è¡Œï¼Œå¯èƒ½ä¼šç»™è¿™ä¸€å¸§å¸¦æ¥è¶…æ—¶çš„é£é™©ã€‚

### èƒ½åšä»€ä¹ˆ

1. æ•°æ®çš„åˆ†æå’Œä¸ŠæŠ¥

- åœ¨ç”¨æˆ·æœ‰æ“ä½œè¡Œä¸ºæ—¶ï¼ˆå¦‚ç‚¹å‡»æŒ‰é’®ã€æ»šåŠ¨é¡µé¢ï¼‰è¿›è¡Œæ•°æ®åˆ†æå¹¶ä¸ŠæŠ¥ã€‚
- å¤„ç†æ•°æ®æ—¶å¾€å¾€ä¼šè°ƒç”¨ JSON.stringify ï¼Œå¦‚æœæ•°æ®é‡è¾ƒå¤§ï¼Œå¯èƒ½ä¼šæœ‰æ€§èƒ½é—®é¢˜ã€‚

æ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ requestIdleCallback è°ƒåº¦ä¸ŠæŠ¥æ—¶æœºï¼Œé¿å…ä¸ŠæŠ¥é˜»å¡é¡µé¢æ¸²æŸ“ï¼Œä¸‹é¢æ˜¯ç®€å•çš„ä»£ç ç¤ºä¾‹ï¼ˆå¯è·³è¿‡ï¼‰

```js
const queues = [];
const btns = btns.forEach(btn => {
    btn.addEventListener('click', e => {
        // do something
        pushQueue({
          type: 'click'
          // ...
        }));
        schedule(); // ç­‰åˆ°ç©ºé—²å†å¤„ç†
    });
});
function schedule() {
    requestIdleCallback(deadline => {
          while (deadline.timeRemaining() > 1) {
              const data = queues.pop();
              // è¿™é‡Œå°±å¯ä»¥å¤„ç†æ•°æ®ã€ä¸Šä¼ æ•°æ®
          }
          if (queues.length) schedule();
    });
}
```

2. é¢„åŠ è½½

åœ¨ç©ºé—²çš„æ—¶å€™åŠ è½½äº›ä¸œè¥¿ï¼Œå¯ä»¥çœ‹çœ‹ [qiankun](https://github.com/umijs/qiankun/blob/master/src/prefetch.ts) çš„ä¾‹å­ï¼Œç”¨æ¥é¢„åŠ è½½ js å’Œ css

```js
function prefetch(entry: Entry, opts?: ImportEntryOpts): void {
  if (!navigator.onLine || isSlowNetwork) {
    // Don't prefetch if in a slow network or offline
    return;
  }

  requestIdleCallback(async () => {
    const { getExternalScripts, getExternalStyleSheets } = await importEntry(entry, opts);
    requestIdleCallback(getExternalStyleSheets);
    requestIdleCallback(getExternalScripts);
  });
}
```

3. æ£€æµ‹å¡é¡¿

- ä¸€èˆ¬æ£€æµ‹çš„å¡é¡¿æ–¹æ³•æœ‰ä¸¤ç§ï¼š
    - æµ‹é‡ fps å€¼ï¼Œå¦‚æœè¿ç»­å‡ºç°å‡ ä¸ª fps å€¼ â‰¤ é˜ˆå€¼ï¼Œåˆ™è®¤ä¸ºæ˜¯å¡é¡¿
    - å¼€è¾Ÿä¸€ä¸ª worker çº¿ç¨‹å’Œä¸»çº¿ç¨‹ä¹‹é—´æ¥ä¸ªå¿ƒè·³æ£€æµ‹ï¼Œä¸€æ®µæ—¶é—´å†…æ²¡å“åº”ï¼Œåˆ™è®¤ä¸ºæ˜¯å¡é¡¿

å›è¿‡å¤´æ¥ï¼Œå¦‚æœ ***requestIdleCallback*** é•¿æ—¶é—´å†…æ²¡èƒ½å¾—åˆ°æ‰§è¡Œï¼Œè¯´æ˜ä¸€ç›´æ²¡æœ‰ç©ºé—²æ—¶é—´ï¼Œå¾ˆæœ‰å¯èƒ½å°±æ˜¯å‘ç”Ÿäº†å¡é¡¿ï¼Œä»è€Œå¯ä»¥æ‰“ç‚¹ä¸ŠæŠ¥ã€‚å®ƒæ¯”è¾ƒé€‚ç”¨äºè¡Œä¸ºå¡é¡¿ï¼Œä¸¾ä¸ªä¾‹å­ï¼šç‚¹å‡»æŸä¸ªæŒ‰é’®å¹¶åŒæ—¶æ·»åŠ æˆ‘ä»¬çš„ ***requestIdleCallback*** å›è°ƒï¼Œå¦‚æœç‚¹å‡»åçš„ä¸€æ®µæ—¶é—´å†…è¿™ä¸ªå›è°ƒæ²¡æœ‰å¾—åˆ°æ‰§è¡Œï¼Œå¾ˆå¤§æ¦‚ç‡æ˜¯è¿™ä¸ªç‚¹å‡»æ“ä½œé€ æˆäº†å¡é¡¿ã€‚

4. æ‹†åˆ†è€—æ—¶ä»»åŠ¡

è¿™ä¸ªæ€æƒ³åœ¨ [React ä¸­çš„è°ƒåº¦å™¨ Scheduler](https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/scheduler/src/Scheduler.js)é‡Œé¢å±•ç°çš„æ·‹æ¼“å°½è‡´ï¼Œè™½ç„¶ React è‡ªå·±å®ç°äº†ä¸€å¥—è°ƒåº¦é€»è¾‘(å…¼å®¹æ€§ã€ç¨³å®šæ€§å’Œä¼˜å…ˆçº§ç­‰åŸå› )ï¼Œä¸è¿‡ä¸å¦¨ç¢æˆ‘ä»¬ç†è§£ã€‚
ç®€å•æ¥è¯´ React æŠŠ diff çš„è¿‡ç¨‹ä»æ—©å‰çš„é€’å½’å˜æˆäº†ç°åœ¨çš„è¿­ä»£ï¼Œå¯¹ä¸¤ä¸ªå¤§å¯¹è±¡è¿›è¡Œé€’å½’ diff å°±æ˜¯ä¸ªè€—æ—¶çš„ä»»åŠ¡ï¼Œå¦‚æœèƒ½å¤Ÿæ‹†è§£æˆå°ä»»åŠ¡ï¼Œé‚£è¯¥æœ‰å¤šå¥½ã€‚ä½†æ˜¯é€’å½’åˆä¸èƒ½ä¸­é€”ç»ˆæ­¢ï¼Œæ‰€ä»¥ React é‡‡ç”¨äº† fiber è¿™ç§æ•°æ®ç»“æ„ï¼ŒæŠŠé€’å½’å˜æˆäº†é“¾è¡¨è¿­ä»£ï¼Œè¿­ä»£å°±å¯ä»¥ä¸­é€”åœæ­¢ï¼Œæˆ‘ä»¬å°±ä¸ç”¨ä¸€æ¬¡æ€§ diff å®Œã€‚
psï¼šä¸æ‡‚é“¾è¡¨çš„åŒå­¦å°±ç®€å•ç†è§£æˆæ˜¯æ•°ç»„å§ï¼Œä½ æƒ³æƒ³å¦‚æœæˆ‘ä»¬è¦æŠŠæ•°ç»„è¿›è¡Œéå†ï¼Œæˆ‘ä»¬å¯ä»¥ä¸€æ¬¡æ€§æ‰§è¡Œå®Œï¼Œä½†æ˜¯æˆ‘ä»¬ä¹Ÿå¯ä»¥æ‹†æˆå‡ æ¬¡æ‰§è¡Œå®Œï¼Œåªè¦æˆ‘ä»¬è®°å½•ä¸ª indexï¼Œä¸‹æ¬¡å›æ¥ç»§ç»­æ‰§è¡Œä»£ç çš„æ—¶å€™å°±ä» index å¼€å§‹éå†å°±è¡Œï¼Œä¸çŸ¥é“å¤§å®¶ get åˆ°æœ¨æœ‰ã€‚


## æ¨¡æ‹Ÿå®ç°requestIdleCallback


### ç”¨ setTimeout å®ç°

é¦–é€‰å¤§å®¶è¦çŸ¥é“ä¸€ä¸ªå‰æï¼Œä¸ºä»€ä¹ˆèƒ½å¤Ÿ setTimeout æ¥æ¨¡æ‹Ÿï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆç®€å•çœ‹ä¸‹ä¸‹é¢è¿™ä¸¤è¡Œä»£ç ï¼š

```js
// æŸç§ç¨‹åº¦ä¸ŠåŠŸèƒ½ç›¸ä¼¼ï¼Œå†™æ³•ä¹Ÿç›¸ä¼¼
requestIdleCallback(() => console.log(1));
setTimeout(() => console.log(2));
```
äº†è§£è¿‡ setTimeout çš„åŒå­¦åº”è¯¥çŸ¥é“è¿™ä¸ªä¸œè¥¿å®ƒä¸å‡†ï¼Œä¸Šé¢é‚£æ ·å†™å¹¶ä¸æ˜¯ç«‹åˆ»æ‰§è¡Œçš„æ„æ€ï¼Œè€Œæ˜¯å°½å¯èƒ½å¿«çš„æ‰§è¡Œï¼Œå°±æ˜¯ç­‰å¾…ä¸»çº¿ç¨‹ä¸ºç©ºï¼Œå¾®ä»»åŠ¡ä¹Ÿæ‰§è¡Œå®Œäº†ï¼Œé‚£ä¹ˆå°±å¯ä»¥è½®åˆ° setTimeout æ‰§è¡Œäº†ï¼Œæ‰€ä»¥ setTimeout(fn) æŸç§ç¨‹åº¦ä¸Šè®²ä¹Ÿæœ‰ç©ºé—²çš„æ„æ€ï¼Œäº†è§£äº†è¿™ä¸ªç‚¹æˆ‘ä»¬å°±å¯ä»¥ç”¨å®ƒæ¥æ¨¡æ‹Ÿå•¦ï¼Œç›´æ¥çœ‹ä¸‹é¢çš„ä»£ç å³å¯ï¼Œå°±æ˜¯åœ¨ setTimeout é‡Œé¢å¤šäº†ä¸ªæ„é€ å‚æ•°çš„æ­¥éª¤ï¼š

```js
window.requestIdleCallback = function(cb) {
    let start = Date.now();
    return setTimeout(function () {
      const deadline = { // è¿™è¾¹å°±æ˜¯ä¸ºäº†æ„é€ å‚æ•°
        timeRemaining: () => Math.max(0, 50 - (Date.now() - start)), // å‰©ä½™æ—¶é—´æˆ‘ä»¬å†™æ­»åœ¨ 50ms å†…ï¼Œä¹Ÿå°±æ˜¯å‰é¢æåˆ°çš„ä¸Šé™å€¼ï¼Œå…¶å®ä½ ä¹Ÿå¯ä»¥å†™æˆ 40ã€30ã€16ã€10 ç­‰ğŸ˜‚
        didTimeout: false // å› ä¸ºæˆ‘ä»¬ä¸æ¨èä½¿ç”¨ timeout å‚æ•°ï¼Œæ‰€ä»¥è¿™é‡Œå°±ç›´æ¥å†™æ­» false
      };
      cb(deadline);
    });
}
```

è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªå¹¶ä¸æ˜¯ requestIdleCallback çš„ polyfill ï¼Œå› ä¸ºå®é™…ä¸Šå®ƒä»¬å¹¶ä¸ç›¸åŒã€‚setTimeout å¹¶ä¸ç®—æ˜¯çœŸæ­£çš„åˆ©ç”¨ç©ºé—²æ—¶é—´ï¼Œè€Œæ˜¯åœ¨æ¡ä»¶å…è®¸çš„æƒ…å†µä¸‹å°½å¯èƒ½å¿«çš„æ‰§è¡Œä½ çš„ä»£ç ã€‚ä¸Šé¢çš„ä»£ç å¹¶ä¸ä¼šåƒçœŸæ­£çš„ requestIdleCallback é‚£æ ·å°†è‡ªå·±é™åˆ¶åœ¨è¿™ä¸€å¸§çš„ç©ºé—²æ—¶é—´å†…ï¼Œä½†æ˜¯å®ƒè¾¾åˆ°äº†ä¸¤ä¸ªæ•ˆæœï¼Œä¸€ä¸ªæ˜¯å°†ä»»åŠ¡åˆ†æ®µï¼Œä¸€ä¸ªæ˜¯æ§åˆ¶æ¯æ¬¡æ‰§è¡Œçš„æ—¶é—´ä¸Šé™ã€‚ä¸€èˆ¬æ»¡è¶³è¿™ä¸¤ä¸ªæ¡ä»¶çš„å°±æ˜¯å®ä»»åŠ¡äº†ï¼Œæ‰€ä»¥é™¤äº† setTimout å¤–ï¼ŒpostMessage ä¹Ÿæ˜¯å¯ä»¥å®ç°çš„ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœ‹æ¨¡æ‹Ÿçš„å¦ä¸€ç§æ–¹æ³•

### ç”¨ requestAnimationFrame + MessageChannel å®ç°

```js
let deadlineTime // å½“å‰å¸§ç»“æŸæ—¶é—´
let callback // éœ€è¦å›è°ƒçš„ä»»åŠ¡

let channel = new MessageChannel(); // postMessage çš„ä¸€ç§ï¼Œè¯¥å¯¹è±¡å®ä¾‹æœ‰ä¸”åªæœ‰ä¸¤ä¸ªç«¯å£ï¼Œå¹¶ä¸”å¯ä»¥ç›¸äº’æ”¶å‘äº‹ä»¶ï¼Œå½“åšæ˜¯å‘å¸ƒè®¢é˜…å³å¯ã€‚
let port1 = channel.port1;
let port2 = channel.port2;

port2.onmessage = () => {
    const timeRemaining = () => deadlineTime - performance.now();
    if (timeRemaining() > 1 && callback) {
        const deadline = { timeRemaining, didTimeout: false }; // åŒæ ·çš„è¿™é‡Œä¹Ÿæ˜¯æ„é€ ä¸ªå‚æ•°
        callback(deadline);
    }
}

window.requestIdleCallback = function(cb) {
    requestAnimationFrame(rafStartTime => {
        // å¤§æ¦‚è¿‡æœŸæ—¶é—´ = é»˜è®¤è¿™æ˜¯ä¸€å¸§çš„å¼€å§‹æ—¶é—´ + ä¸€å¸§å¤§æ¦‚è€—æ—¶
        deadlineTime = rafStartTime + 16
        callback = cb
        port1.postMessage(null);
    });
 }
```

ä¸Šé¢è¿™ç§æ–¹å¼ä¼šæ¯” setTimeout ç¨å¥½ä¸€äº›ï¼Œå› ä¸º MessageChannel çš„æ‰§è¡Œåœ¨ setTimeout ä¹‹å‰ï¼Œå¹¶ä¸”æ²¡æœ‰ 4ms çš„æœ€å°å»¶æ—¶ã€‚
é‚£ä¸ºä»€ä¹ˆä¸ç”¨å¾®ä»»åŠ¡æ¨¡æ‹Ÿå‘¢ï¼Ÿå› ä¸ºå¦‚æœä½ ç”¨å¾®ä»»åŠ¡æ¨¡æ‹Ÿçš„è¯ï¼Œåœ¨ä»£ç æ‰§è¡Œå®Œä¹‹åï¼Œæ‰€æœ‰çš„å¾®ä»»åŠ¡å°±ä¼šç»§ç»­å…¨éƒ¨æ‰§è¡Œï¼Œä¸èƒ½åŠæ—¶çš„è®©å‡ºä¸»çº¿ç¨‹ã€‚

- psï¼šè¿™ä¸¤ç§æ–¹æ³•éƒ½ä¸æ˜¯ polyfillï¼Œåªæ˜¯å°½å¯èƒ½é è¿‘ requestIdleCallbackï¼Œå¹¶ä¸”å‰©ä½™æ—¶é—´ä¹Ÿæ˜¯çŒœæµ‹çš„ã€‚

## requestIdleCallbackä¸Reactä¸­çš„æ—¶é—´åˆ‡ç‰‡æœ‰ä»€ä¹ˆå…³ç³»

[RequestIdleCallback å®éªŒæ¡ˆä¾‹](https://github.com/Linjiayu6/FE-RequestIdleCallback-demo)

- ç»“è®ºï¼š
    - requestIdleCallback æ˜¯åˆ©ç”¨å¸§ä¹‹é—´ç©ºé—²æ—¶é—´æ¥æ‰§è¡ŒJS
    - requestIdleCallback æ˜¯åœ¨ layout å’Œ paint ä¹‹å, æ„å‘³ç€requestIdleCallback æ˜¯å¯ä»¥jsè®¡ç®—å¹¶æ”¹å˜DOMçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä¼š è§¦å‘é‡æ–° layout å’Œ paint
    - requestAnimationFrame æ˜¯åœ¨ layout å’Œ paint ä¹‹å‰ï¼Œå› æ­¤æ›´é€‚åˆå˜æ›´DOMæ“ä½œã€‚
    - å› æ­¤Reactå†…éƒ¨å¯¹è°ƒåº¦ç­–ç•¥çš„å®ç°ä¹Ÿæ˜¯åŸºäºrequestAnimationFrameçš„
- æ•…ï¼š
    - RequestIdleCallback å®šä½ä¸ºå¤„ç†ä¸é‡è¦ä¸”ä¸ç´§æ€¥çš„äº‹ç‰©ã€‚å› ä¸ºReactæ¸²æŸ“å†…å®¹ï¼Œå¹¶éæ˜¯ä¸é‡è¦ä¸”ä¸ç´§æ€¥ã€‚ä¸ä»…è¯¥apiå…¼å®¹ä¸€èˆ¬ï¼Œå¸§æ¸²æŸ“èƒ½åŠ›ä¸€èˆ¬ï¼Œä¹Ÿä¸å¤ªç¬¦åˆæ¸²æŸ“è¯‰æ±‚ï¼Œæ•…React å›¢é˜Ÿè‡ªè¡Œå®ç°
### Reactæºç ä¸­çš„requestHostCallback

- [SchedulerHostConfig.js](https://github.com/facebook/react/blob/v17.0.1/packages/scheduler/src/forks/SchedulerHostConfig.default.js)

- æ‰§è¡Œå®ä»»åŠ¡(å›è°ƒä»»åŠ¡)
    - requestHostCallback: è§¦å‘ä¸€ä¸ªå®ä»»åŠ¡ performWorkUntilDeadlineã€‚
    - performWorkUntilDeadline: å®ä»»åŠ¡å¤„ç†ã€‚
        - æ˜¯å¦æœ‰å¯Œè£•æ—¶é—´, æœ‰åˆ™æ‰§è¡Œã€‚
        - æ‰§è¡Œè¯¥å›è°ƒä»»åŠ¡åï¼Œæ˜¯å¦è¿˜æœ‰ä¸‹ä¸€ä¸ªå›è°ƒä»»åŠ¡, å³åˆ¤æ–­ hasMoreWorkã€‚
        - æœ‰åˆ™ç»§ç»­æ‰§è¡Œ port.postMessage(null);

```js
  let scheduledHostCallback = null;

  let isMessageLoopRunning = false;

  const channel = new MessageChannel();

  // port2 å‘é€
  const port = channel.port2;
  // port1 æ¥æ”¶
  channel.port1.onmessage = performWorkUntilDeadline;
  const performWorkUntilDeadline = () => {
    // æœ‰æ‰§è¡Œä»»åŠ¡
    if (scheduledHostCallback !== null) {
      const currentTime = getCurrentTime();
      // Yield after `yieldInterval` ms, regardless of where we are in the vsync

      // cycle. This means there's always time remaining at the beginning of
      // the message event.

      // è®¡ç®—ä¸€å¸§çš„è¿‡æœŸæ—¶é—´ç‚¹
      deadline = currentTime + yieldInterval;
      const hasTimeRemaining = true;
      try {
        // æ‰§è¡Œå®Œè¯¥å›è°ƒå, åˆ¤æ–­åç»­æ˜¯å¦è¿˜æœ‰å…¶ä»–ä»»åŠ¡
        const hasMoreWork = scheduledHostCallback(
          hasTimeRemaining,
          currentTime,
        );

        if (!hasMoreWork) {
          isMessageLoopRunning = false;
          scheduledHostCallback = null;

        } else {
          // If there's more work, schedule the next message event at the end
          // of the preceding one.
          // è¿˜æœ‰å…¶ä»–ä»»åŠ¡, æ¨è¿›è¿›å…¥ä¸‹ä¸€ä¸ªå®ä»»åŠ¡é˜Ÿåˆ—ä¸­
          port.postMessage(null);
        }

      } catch (error) {
        // If a scheduler task throws, exit the current browser task so the
        // error can be observed.
        port.postMessage(null);
        throw error;
      }

    } else {
      isMessageLoopRunning = false;
    }
    // Yielding to the browser will give it a chance to paint, so we can
    // reset this.
    needsPaint = false;

  };

  // requestHostCallback ä¸€å¸§ä¸­æ‰§è¡Œä»»åŠ¡
  requestHostCallback = function(callback) {
    // å›è°ƒæ³¨å†Œ
    scheduledHostCallback = callback;

    if (!isMessageLoopRunning) {
      isMessageLoopRunning = true;
      // è¿›å…¥å®ä»»åŠ¡é˜Ÿåˆ—
      port.postMessage(null);
    }

  };

  cancelHostCallback = function() {
    scheduledHostCallback = null;

  };
```



## å‚è€ƒ

[requestIdleCallback-MDN](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestIdleCallback)

[[Reactæºç ç¬”è®°]requestIdleCallbackæ˜¯ä»€ä¹ˆ](https://juejin.cn/post/7041457381938561055)

[æ¥æ·±å…¥äº†è§£ä¸‹requestIdleCallback](https://juejin.cn/post/7033959714794766372)

[å®ç° React requestIdleCallback è°ƒåº¦èƒ½åŠ›](https://juejin.cn/post/7021506472232583199)
